"use strict";(self.webpackChunkegoexo_docs=self.webpackChunkegoexo_docs||[]).push([[7948],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>f});var a=t(7294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var s=a.createContext({}),c=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},p=function(e){var n=c(e.components);return a.createElement(s.Provider,{value:n},e.children)},d="mdxType",_={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=c(t),m=o,f=d["".concat(s,".").concat(m)]||d[m]||_[m]||i;return t?a.createElement(f,r(r({ref:n},p),{},{components:t})):a.createElement(f,r({ref:n},p))}));function f(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var i=t.length,r=new Array(i);r[0]=m;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[d]="string"==typeof e?e:o,r[1]=l;for(var c=2;c<i;c++)r[c]=t[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},3046:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>r,default:()=>_,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var a=t(7462),o=(t(7294),t(3905));const i={},r="Tutorial 2: Hand and Body Pose in Ego-Exo4D Dataset",l={unversionedId:"tutorials/pose",id:"tutorials/pose",title:"Tutorial 2: Hand and Body Pose in Ego-Exo4D Dataset",description:"Status",source:"@site/docs/tutorials/pose.md",sourceDirName:"tutorials",slug:"/tutorials/pose",permalink:"/tutorials/pose",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Tutorial 1: Gaze in Ego-Exo4D Dataset",permalink:"/tutorials/gaze"},next:{title:"Tutorial 3: Undistort frames and overlay annotations",permalink:"/tutorials/undistort"}},s={},c=[{value:"1. Prerequisites and Imports",id:"1-prerequisites-and-imports",level:3},{value:"2. Load one sample take and its ego / exo camera&#39;s camera calibration.",id:"2-load-one-sample-take-and-its-ego--exo-cameras-camera-calibration",level:3},{value:"2.1 load exocentric camera calibrations",id:"21-load-exocentric-camera-calibrations",level:4},{value:"2.2 load egocentric camera calibrations",id:"22-load-egocentric-camera-calibrations",level:4},{value:"3. Load body / hand pose and project it to exocentric views",id:"3-load-body--hand-pose-and-project-it-to-exocentric-views",level:3},{value:"3. Projecting pose to egocentric view using camera info",id:"3-projecting-pose-to-egocentric-view-using-camera-info",level:3},{value:"Conclusion",id:"conclusion",level:3}],p={toc:c},d="wrapper";function _(e){let{components:n,...i}=e;return(0,o.kt)(d,(0,a.Z)({},p,i,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"tutorial-2-hand-and-body-pose-in-ego-exo4d-dataset"},"Tutorial 2: Hand and Body Pose in Ego-Exo4D Dataset"),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://img.shields.io/static/v1.svg?label=Status&message=Finished&color=green",alt:"Status"})),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Filled notebook:"),"\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/facebookresearch/Ego4d/tree/main/notebooks/egoexo"},(0,o.kt)("img",{parentName:"a",src:"https://img.shields.io/static/v1.svg?logo=github&label=Tutorial&message=View%20On%20Github&color=lightgrey",alt:"View on Github"})),"\n",(0,o.kt)("strong",{parentName:"p"},"Author:")," Xizi Wang"),(0,o.kt)("p",null,"3D hand and body pose are two important annotations of the Ego-Exo4D dataset. The figure on the left captures the ",(0,o.kt)("strong",{parentName:"p"},"full body pose")," and surrounding environment context, whereas the figure on the right captures the details of close-by ",(0,o.kt)("strong",{parentName:"p"},"hand-object")," interactions and the camera wearer\u2019s attention. In this tutorial, we provide a step-by-step guide on retrieving the hand and body pose of one example take, and projecting the body pose to exocentric views and the hand pose to egocentric views, then visualizing it on the corresponding frame."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Samples of hand and body pose",src:t(2923).Z,width:"1706",height:"778"})),(0,o.kt)("h3",{id:"1-prerequisites-and-imports"},"1. Prerequisites and Imports"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'%matplotlib inline\nimport cv2\nimport matplotlib.pyplot as plt\nimport numpy as np\nimport math\nfrom matplotlib import rcParams\nfrom projectaria_tools.core import mps\nfrom projectaria_tools.core import data_provider\nfrom projectaria_tools.core import calibration\nfrom projectaria_tools.core.calibration import CameraCalibration, KANNALA_BRANDT_K3\nfrom projectaria_tools.core.stream_id import StreamId\n\nrcParams["figure.figsize"] = 16, 32\n\nimport json\nimport os\nimport random\n\nimport av\nimport pandas as pd\nfrom PIL import Image, ImageDraw\nfrom tqdm.auto import tqdm\n\n')),(0,o.kt)("p",null,"Next we define some necessary utility functions for retrieving pose metadata and drawing functions."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'# Loads dataframe at target path to csv\ndef load_csv_to_df(filepath: str) -> pd.DataFrame:\n    with open(filepath, "r") as csv_file:\n        return pd.read_csv(csv_file)\n\n# color palette for drawing the keypoints\npalette = np.array(\n    [\n        [255, 128, 0],\n        [255, 153, 51],\n        [255, 178, 102],\n        [230, 230, 0],\n        [255, 153, 255],\n        [153, 204, 255],\n        [255, 102, 255],\n        [255, 51, 255],\n        [102, 178, 255],\n        [51, 153, 255],\n        [255, 153, 153],\n        [255, 102, 102],\n        [255, 51, 51],\n        [153, 255, 153],\n        [102, 255, 102],\n        [51, 255, 51],\n        [0, 255, 0],\n        [0, 0, 255],\n        [255, 0, 0],\n        [255, 255, 255],\n    ]\n)\n\n\n# retrieve the body keypoints and skeleton\ndef get_body_metadata():\n    keypoints_map = [\n        {"label": "Nose", "id": "fee3cbd2", "color": "#f77189"},\n        {"label": "Left-eye", "id": "ab12de34", "color": "#d58c32"},\n        {"label": "Right-eye", "id": "7f2g1h6k", "color": "#a4a031"},\n        {"label": "Left-ear", "id": "mn0pqrst", "color": "#50b131"},\n        {"label": "Right-ear", "id": "yz89wx76", "color": "#34ae91"},\n        {"label": "Left-shoulder", "id": "5a4b3c2d", "color": "#37abb5"},\n        {"label": "Right-shoulder", "id": "e1f2g3h4", "color": "#3ba3ec"},\n        {"label": "Left-elbow", "id": "6i7j8k9l", "color": "#bb83f4"},\n        {"label": "Right-elbow", "id": "uv0wxy12", "color": "#f564d4"},\n        {"label": "Left-wrist", "id": "3z4ab5cd", "color": "#2fd4aa"},\n        {"label": "Right-wrist", "id": "efgh6789", "color": "#94d14f"},\n        {"label": "Left-hip", "id": "ijklmnop", "color": "#b3d32c"},\n        {"label": "Right-hip", "id": "qrstuvwx", "color": "#f9b530"},\n        {"label": "Left-knee", "id": "yz012345", "color": "#83f483"},\n        {"label": "Right-knee", "id": "6bc7defg", "color": "#32d58c"},\n        {"label": "Left-ankle", "id": "hijk8lmn", "color": "#3ba3ec"},\n        {"label": "Right-ankle", "id": "opqrs1tu", "color": "#f564d4"},\n    ]\n\n    # pyre-ignore\n    pose_kpt_color = palette[[16, 16, 16, 16, 16, 9, 9, 9, 9, 9, 9, 0, 0, 0, 0, 0, 0]]\n\n    skeleton = [\n        [16, 14],\n        [14, 12],\n        [17, 15],\n        [15, 13],\n        [12, 13],\n        [6, 12],\n        [7, 13],\n        [6, 7],\n        [6, 8],\n        [7, 9],\n        [8, 10],\n        [9, 11],\n        [2, 3],\n        [1, 2],\n        [1, 3],\n        [2, 4],\n        [3, 5],\n        [4, 6],\n        [5, 7],\n    ]\n    return keypoints_map, skeleton, pose_kpt_color\n\n\n# retrieve the hand keypoints and skeleton\ndef get_hands_metadata():\n    keypoints_map = [\n        {"label": "Right_Wrist", "id": "fee3cbd2", "color": "#f77189"},\n        {"label": "Right_Thumb_1", "id": "yz012345", "color": "#83f483"},\n        {"label": "Right_Thumb_2", "id": "6bc7defg", "color": "#32d58c"},\n        {"label": "Right_Thumb_3", "id": "hijk8lmn", "color": "#3ba3ec"},\n        {"label": "Right_Thumb_4", "id": "opqrs1tu", "color": "#f564d4"},\n        {"label": "Right_Index_1", "id": "ab12de34", "color": "#d58c32"},\n        {"label": "Right_Index_2", "id": "7f2g1h6k", "color": "#a4a031"},\n        {"label": "Right_Index_3", "id": "mn0pqrst", "color": "#50b131"},\n        {"label": "Right_Index_4", "id": "9vwxyzab", "color": "#32d58c"},\n        {"label": "Right_Middle_1", "id": "yz89wx76", "color": "#34ae91"},\n        {"label": "Right_Middle_2", "id": "5a4b3c2d", "color": "#37abb5"},\n        {"label": "Right_Middle_3", "id": "e1f2g3h4", "color": "#3ba3ec"},\n        {"label": "Right_Middle_4", "id": "cdefgh23", "color": "#3ba3ec"},\n        {"label": "Right_Ring_1", "id": "efgh6789", "color": "#94d14f"},\n        {"label": "Right_Ring_2", "id": "ijklmnop", "color": "#b3d32c"},\n        {"label": "Right_Ring_3", "id": "qrstuvwx", "color": "#f9b530"},\n        {"label": "Right_Ring_4", "id": "ijkl4567", "color": "#bb83f4"},\n        {"label": "Right_Pinky_1", "id": "6i7j8k9l", "color": "#bb83f4"},\n        {"label": "Right_Pinky_2", "id": "uv0wxy12", "color": "#f564d4"},\n        {"label": "Right_Pinky_3", "id": "3z4ab5cd", "color": "#2fd4aa"},\n        {"label": "Right_Pinky_4", "id": "mnop8qrs", "color": "#f564d4"},\n        {"label": "Left_Wrist", "id": "fee3cbd2_left", "color": "#f77189"},\n        {"label": "Left_Thumb_1", "id": "yz012345_left", "color": "#83f483"},\n        {"label": "Left_Thumb_2", "id": "6bc7defg_left", "color": "#32d58c"},\n        {"label": "Left_Thumb_3", "id": "hijk8lmn_left", "color": "#3ba3ec"},\n        {"label": "Left_Thumb_4", "id": "opqrs1tu_left", "color": "#f564d4"},\n        {"label": "Left_Index_1", "id": "ab12de34_left", "color": "#d58c32"},\n        {"label": "Left_Index_2", "id": "7f2g1h6k_left", "color": "#a4a031"},\n        {"label": "Left_Index_3", "id": "mn0pqrst_left", "color": "#50b131"},\n        {"label": "Left_Index_4", "id": "9vwxyzab_left", "color": "#32d58c"},\n        {"label": "Left_Middle_1", "id": "yz89wx76_left", "color": "#34ae91"},\n        {"label": "Left_Middle_2", "id": "5a4b3c2d_left", "color": "#37abb5"},\n        {"label": "Left_Middle_3", "id": "e1f2g3h4_left", "color": "#3ba3ec"},\n        {"label": "Left_Middle_4", "id": "cdefgh23_left", "color": "#3ba3ec"},\n        {"label": "Left_Ring_1", "id": "efgh6789_left", "color": "#94d14f"},\n        {"label": "Left_Ring_2", "id": "ijklmnop_left", "color": "#b3d32c"},\n        {"label": "Left_Ring_3", "id": "qrstuvwx_left", "color": "#f9b530"},\n        {"label": "Left_Ring_4", "id": "ijkl4567_left", "color": "#bb83f4"},\n        {"label": "Left_Pinky_1", "id": "6i7j8k9l_left", "color": "#bb83f4"},\n        {"label": "Left_Pinky_2", "id": "uv0wxy12_left", "color": "#f564d4"},\n        {"label": "Left_Pinky_3", "id": "3z4ab5cd_left", "color": "#2fd4aa"},\n        {"label": "Left_Pinky_4", "id": "mnop8qrs_left", "color": "#f564d4"},\n    ]\n\n    links = {\n        "fee3cbd2": ["ab12de34", "yz89wx76", "6i7j8k9l", "efgh6789", "yz012345"],\n        "ab12de34": ["7f2g1h6k"],\n        "7f2g1h6k": ["mn0pqrst"],\n        "mn0pqrst": ["9vwxyzab"],\n        "yz89wx76": ["5a4b3c2d"],\n        "5a4b3c2d": ["e1f2g3h4"],\n        "e1f2g3h4": ["cdefgh23"],\n        "6i7j8k9l": ["uv0wxy12"],\n        "uv0wxy12": ["3z4ab5cd"],\n        "3z4ab5cd": ["mnop8qrs"],\n        "efgh6789": ["ijklmnop"],\n        "ijklmnop": ["qrstuvwx"],\n        "qrstuvwx": ["ijkl4567"],\n        "yz012345": ["6bc7defg"],\n        "6bc7defg": ["hijk8lmn"],\n        "hijk8lmn": ["opqrs1tu"],\n        "fee3cbd2_left": [\n            "ab12de34_left",\n            "yz89wx76_left",\n            "6i7j8k9l_left",\n            "efgh6789_left",\n            "yz012345_left",\n        ],\n        "ab12de34_left": ["7f2g1h6k_left"],\n        "7f2g1h6k_left": ["mn0pqrst_left"],\n        "mn0pqrst_left": ["9vwxyzab_left"],\n        "yz89wx76_left": ["5a4b3c2d_left"],\n        "5a4b3c2d_left": ["e1f2g3h4_left"],\n        "e1f2g3h4_left": ["cdefgh23_left"],\n        "6i7j8k9l_left": ["uv0wxy12_left"],\n        "uv0wxy12_left": ["3z4ab5cd_left"],\n        "3z4ab5cd_left": ["mnop8qrs_left"],\n        "efgh6789_left": ["ijklmnop_left"],\n        "ijklmnop_left": ["qrstuvwx_left"],\n        "qrstuvwx_left": ["ijkl4567_left"],\n        "yz012345_left": ["6bc7defg_left"],\n        "6bc7defg_left": ["hijk8lmn_left"],\n        "hijk8lmn_left": ["opqrs1tu_left"],\n    }\n\n    hand_dict = dict()\n    for index, kpt in enumerate(keypoints_map):\n        hand_dict[kpt["id"]] = index + 1\n\n    skeleton = list()\n    for start_point in links:\n        end_points = links[start_point]\n        for end_point in end_points:\n            start_index = hand_dict[start_point]\n            end_index = hand_dict[end_point]\n            skeleton.append([start_index, end_index])\n\n    klist = [0]\n    klist.extend([2] * 4)\n    klist.extend([4] * 4)\n    klist.extend([6] * 4)\n    klist.extend([8] * 4)\n    klist.extend([10] * 4)\n    klist.extend([0])\n    klist.extend([2] * 4)\n    klist.extend([4] * 4)\n    klist.extend([6] * 4)\n    klist.extend([8] * 4)\n    klist.extend([10] * 4)\n\n    pose_kpt_color = palette[klist]\n    return keypoints_map, skeleton, pose_kpt_color\n\ndef get_coords(annot):\n    pts = dict()\n    for k in annot:\n        atype = 1\n        if annot[k]["placement"] == "auto":\n            atype = 0\n        pts[k] = [annot[k]["x"], annot[k]["y"], atype]\n    return pts\n\n\ndef draw_skeleton(img, all_pts, skeleton):\n    draw = ImageDraw.Draw(img)\n    for item in skeleton:\n        left_index = item[0] - 1\n        right_index = item[1] - 1\n        left_pt = all_pts[left_index]\n        right_pt = all_pts[right_index]\n        if len(left_pt) == 0 or len(right_pt) == 0:\n            continue\n        draw.line([left_pt, right_pt], fill="white", width=10)\n\n\ndef draw_cross(img, x, y, color):\n    draw = ImageDraw.Draw(img)\n    # Circle parameters\n    center = (x, y)  # Center of the cross\n    cross_length = 10  # Half-length of the cross arms\n    # Calculate the end points of the cross\n    left_point = (center[0] - cross_length, center[1])\n    right_point = (center[0] + cross_length, center[1])\n    top_point = (center[0], center[1] - cross_length)\n    bottom_point = (center[0], center[1] + cross_length)\n\n    # Draw the horizontal line\n    draw.line([left_point, right_point], fill=color, width=3)\n    # Draw the vertical line\n    draw.line([top_point, bottom_point], fill=color, width=3)\n\n\ndef draw_circle(img, x, y, color):\n    draw = ImageDraw.Draw(img)\n    # Circle parameters\n    center = (x, y)  # Center of the circle\n    radius = 12  # Radius of the circle\n\n    # Calculate the bounding box of the circle\n    left_up_point = (center[0] - radius, center[1] - radius)\n    right_down_point = (center[0] + radius, center[1] + radius)\n\n    # Draw the circle with a black outline\n    draw.ellipse(\n        [left_up_point, right_down_point], outline=(255, 255, 255), fill=color, width=6\n    )\n\n\ndef draw_label(img, x, y, color, label):\n    draw = ImageDraw.Draw(img)\n    font = ImageFont.load_default(size=40)\n    # Circle parameters\n    center = (x + 20, y - 20)  # Center of the circle\n    draw.text(center, label, fill=color, font=font)\n\ndef draw_skeleton_hands(img, all_pts, skeleton, ratio=1):\n    draw = ImageDraw.Draw(img)\n    for item in skeleton:\n        left_index = item[0] - 1\n        right_index = item[1] - 1\n        left_pt = all_pts[left_index]\n        right_pt = all_pts[right_index]\n        if len(left_pt) == 0 or len(right_pt) == 0:\n            continue\n        draw.line([left_pt, right_pt], fill="white", width=int(ratio * 4))\n\n\ndef draw_circle_hands(img, x, y, color, ratio=1):\n    draw = ImageDraw.Draw(img)\n    # Circle parameters\n    center = (x, y)  # Center of the circle\n    radius = int(ratio * 8)  # Radius of the circle\n\n    # Calculate the bounding box of the circle\n    left_up_point = (center[0] - radius, center[1] - radius)\n    right_down_point = (center[0] + radius, center[1] + radius)\n\n    # Draw the circle with a black outline\n    draw.ellipse(\n        [left_up_point, right_down_point],\n        outline=(255, 255, 255),\n        fill=color,\n        width=int(ratio * 4),\n    )\n\n\ndef draw_cross_hands(img, x, y, color, ratio=1):\n    draw = ImageDraw.Draw(img)\n    # Circle parameters\n    center = (x, y)  # Center of the cross\n    cross_length = int(ratio * 8)  # Half-length of the cross arms\n    # Calculate the end points of the cross\n    left_point = (center[0] - cross_length, center[1])\n    right_point = (center[0] + cross_length, center[1])\n    top_point = (center[0], center[1] - cross_length)\n    bottom_point = (center[0], center[1] + cross_length)\n\n    # Draw the horizontal line\n    draw.line([left_point, right_point], fill=color, width=int(ratio * 4))\n    # Draw the vertical line\n    draw.line([top_point, bottom_point], fill=color, width=int(ratio * 4))\n\n\ndef show_results(results):\n    for cam_name in results:\n        img = results[cam_name]\n        plt.figure(figsize=(40, 20))\n        plt.imshow(img)\n        plt.axis("off")  # Hide the axes ticks\n        plt.title(f"{cam_name}", fontsize=20)\n        plt.savefig(f"{cam_name}.png")\n        #plt.show()\n\n\ndef get_viz(\n    pil_img,\n    keypoints_map,\n    ann,\n    skeleton,\n    pose_kpt_color,\n    annot_type="body",\n    is_aria=False,\n):\n    pts = get_coords(ann)\n    ratio = 1\n    if is_aria:\n        ratio = 0.5\n\n    all_pts = []\n    for _, keypoints in enumerate(keypoints_map):\n        kpname = keypoints["label"].lower()\n\n        if kpname in pts:\n            x, y = pts[kpname][0], pts[kpname][1]\n            all_pts.append((x, y))\n        else:\n            all_pts.append(())\n\n    if annot_type == "body":\n        draw_skeleton(pil_img, all_pts, skeleton)\n    else:\n        draw_skeleton_hands(pil_img, all_pts, skeleton, ratio)\n\n    for index, keypoints in enumerate(keypoints_map):\n        kpname = keypoints["label"].lower()\n        if kpname in pts:\n            x, y, pt_type = pts[kpname][0], pts[kpname][1], pts[kpname][2]\n            color = tuple(pose_kpt_color[index])\n            if pt_type == 1:\n                if annot_type == "body":\n                    draw_circle(pil_img, x, y, color)\n                else:\n                    draw_circle_hands(pil_img, x, y, color, ratio)\n            else:\n                if annot_type == "body":\n                    draw_cross(pil_img, x, y, color)\n                else:\n                    draw_cross_hands(pil_img, x, y, color, ratio)\n            if annot_type == "body":\n                draw_label(pil_img, x, y, color, kpname)\n\n        else:\n            pass\n    return pil_img\n\n\n# Video Utilities\ndef get_frame(video_local_path, frame_idx):\n    container = av.open(video_local_path)\n    frame_count = 0\n    for frame in container.decode(video=0):\n        if frame_count == frame_idx:\n            input_img = np.array(frame.to_image())\n            pil_img = Image.fromarray(input_img)\n            return pil_img\n        frame_count += 1\n')),(0,o.kt)("h3",{id:"2-load-one-sample-take-and-its-ego--exo-cameras-camera-calibration"},"2. Load one sample take and its ego / exo camera's camera calibration."),(0,o.kt)("p",null,"First, let's define the Ego-Exo4D dataset and its annotation location."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'release_dir = "/datasets01/egoexo4d/v2/" # replace this with your download folder\nannotation_dir = os.path.join(release_dir, "annotations/")  # annotation folder\n\n# load necessary annotation files\negoexo = {\n    "takes": os.path.join(release_dir, "takes.json"),\n    "captures": os.path.join(release_dir, "captures.json")\n}\n\nfor k, v in egoexo.items():\n    egoexo[k] = json.load(open(v))\n\ntakes = egoexo["takes"]\ncaptures = egoexo["captures"]\ntakes_by_uid = {x["take_uid"]: x for x in takes}\n')),(0,o.kt)("p",null,"We then randomly sample one example take of playing piano. We also provide the take uid of some other takes as examples."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'#take_uid = "0bc47e29-e086-4726-b874-f89671366f06"  # Violin\ntake_uid = "23ff1c48-01ea-4d34-a38b-bc96e767b9b9" #Piano\n#take_uid = "02715c86-e30c-4791-92b7-38b488e51aba"  # Bike\n\ntake = [take for take in egoexo["takes"] if take["take_uid"] == take_uid]\ntake = take[0]\n')),(0,o.kt)("p",null,"And load the camera intrinsics and extrinsics of the take. ",(0,o.kt)("strong",{parentName:"p"},"exo_traj_df")," reads in the exocentric cameras calibrations in csv format."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'# Initialize exo cameras from calibration file\ntraj_dir = os.path.join(release_dir, take["root_dir"], "trajectory")\nexo_traj_path = os.path.join(traj_dir, "gopro_calibs.csv")\n\nexo_traj_df = load_csv_to_df(exo_traj_path)\nexo_cam_names = list(exo_traj_df["cam_uid"])\nego_cam_names = [x["cam_id"] for x in take["capture"]["cameras"] if x["is_ego"] and x["cam_id"].startswith("aria")]\nall_cams = ego_cam_names + exo_cam_names\nego_cam_name = ego_cam_names[0]\nprint("exo cameras:\\t", exo_cam_names)\nprint("ego camera:\\t", ego_cam_name)\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"exo cameras:     ['gp01', 'gp02', 'gp03', 'gp04', 'gp05']\nego camera:  aria01\n")),(0,o.kt)("h4",{id:"21-load-exocentric-camera-calibrations"},"2.1 load exocentric camera calibrations"),(0,o.kt)("p",null,"The exocentric camera calibrations can be read using Project Aria Machine Perception Services (MPS). We store them with camera uid as keys in ",(0,o.kt)("strong",{parentName:"p"},"go_pro_proxy"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'go_pro_proxy = {}\nstatic_calibrations = mps.read_static_camera_calibrations(exo_traj_path)\nfor static_calibration in static_calibrations:\n    # assert the GoPro was correctly localized\n    if static_calibration.quality != 1.0:\n        print(f"Camera: {static_calibration.camera_uid} was not localized, ignoring this camera.")\n        continue\n    proxy = {}\n    proxy["name"] = static_calibration.camera_uid\n    proxy["pose"] = static_calibration.transform_world_cam\n    proxy["camera"] = CameraCalibration(\n                            static_calibration.camera_uid,\n                            KANNALA_BRANDT_K3,\n                            static_calibration.intrinsics,\n                            static_calibration.transform_world_cam, # probably extrinsics\n                            static_calibration.width,\n                            static_calibration.height,\n                            None,\n                            math.pi,\n                            "")\n\n    go_pro_proxy[static_calibration.camera_uid] = proxy\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Camera: gp05 was not localized, ignoring this camera.\nLoaded #StaticCameraCalibration data: 5\n")),(0,o.kt)("h4",{id:"22-load-egocentric-camera-calibrations"},"2.2 load egocentric camera calibrations"),(0,o.kt)("p",null,"We read the egocentric camera intrinsics using VRS and camera extrinsics using MPS."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'## Configure the VRSDataProvider (interface used to retrieve Trajectory data)\nego_exo_project_path = os.path.join(release_dir, \'takes\', take[\'take_name\'])\n\naria_dir = os.path.join(release_dir, take["root_dir"])\naria_path = os.path.join(aria_dir, f"{ego_cam_name}.vrs")\nvrs_data_provider = data_provider.create_vrs_data_provider(aria_path)\ndevice_calibration = vrs_data_provider.get_device_calibration()\n\nrgb_stream_id = StreamId("214-1")\nrgb_stream_label = vrs_data_provider.get_label_from_stream_id(rgb_stream_id)\nrgb_camera_calibration = device_calibration.get_camera_calib(rgb_stream_label)\n\nmps_data_paths_provider = mps.MpsDataPathsProvider(ego_exo_project_path)\nmps_data_paths = mps_data_paths_provider.get_data_paths()\nmps_data_provider = mps.MpsDataProvider(mps_data_paths)\n')),(0,o.kt)("h3",{id:"3-load-body--hand-pose-and-project-it-to-exocentric-views"},"3. Load body / hand pose and project it to exocentric views"),(0,o.kt)("p",null,"In this section, we go through the steps of projecting body / hand pose to exocentric views. We first load the annotation file of the pose. The annotation is a dictionary with the frame indices as keys. As an example, we randomly sample the 3D and 2D annotation of one frame. You can switch annotation_type to choose between body and hand."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'annotation_type = "hand" # annotation_type should be body or hand.\n\n# get body pose annotation folder\negopose_ann_dir = os.path.join(\n    annotation_dir, f"ego_pose/train/{annotation_type}/annotation"\n)\n# get the annotation file of the sampled take\nannotation_file_path = os.path.join(egopose_ann_dir, f"{take_uid}.json")\nall_annotations = json.load(open(annotation_file_path))\n# annotation is a dictionary with frame numbers as keys, we then randomly sample one frame.\nframe_idx = random.sample(list(all_annotations.keys()), 1)[0]\nannotation = all_annotations[frame_idx][0]\nframe_idx = int(frame_idx)\nprint(f"annotation at sampled frame {frame_idx} is {annotation.keys()}.")\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"annotation at sampled frame 3382 is dict_keys(['annotation3D', 'annotation2D']).\n")),(0,o.kt)("p",null,"Next we read the corresponding at the sampled frame index from exocentric videos and egocentric video. We store it in a dictionary ",(0,o.kt)("strong",{parentName:"p"},"videos")," with camera name as key."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"base_directory = os.path.join(release_dir, take[\"root_dir\"])\nvideos = {}\nfor cam_name in all_cams:\n    if cam_name in exo_cam_names:\n        stream_name = '0'\n    else:\n        stream_name = 'rgb'\n\n    local_path = os.path.join(base_directory, take['frame_aligned_videos'][cam_name][stream_name]['relative_path'])\n    container = av.open(local_path)\n    videos[cam_name] = get_frame(local_path, frame_idx)\n")),(0,o.kt)("p",null,"We retrieve the pose in the format of 3D keypoints from the annotation file. 3D keypoints are world coordinates of the pose. Note that annotation also have ",(0,o.kt)("strong",{parentName:"p"},"annotation2D")," which are 2D keypoints annotated on undistorted frames. We will show this part later in projecting hand pose to egocentric frame."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"parts = list(annotation[\"annotation3D\"].keys())\nannot_3d = {}\nfor part in parts:\n    keypoint = annotation[\"annotation3D\"][part]\n    annot_3d[part] = [keypoint['x'], keypoint['y'], keypoint['z']]\n")),(0,o.kt)("p",null,"With exocentric camera calibration, we project the 3D body/hand keypoints to different exocentric views. The process is similar to the reprojection in the gaze tutorial. The body/hand keypoint is first projected from world coordinates to exocentric camera device, then to the exocentric camera image plane."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"per_go_pro_reprojection = {}\nfor go_pro in go_pro_proxy:\n    if go_pro not in per_go_pro_reprojection.keys():\n        per_go_pro_reprojection[go_pro] = {}\n    for part in parts:\n        pose_vector_in_world = annot_3d[part]\n        # project the keypoint from world to go_pro device\n        pose_in_go_pro_world = go_pro_proxy[go_pro][\"pose\"].inverse() @ pose_vector_in_world\n\n        # project the keypoint from go_pro device to go_pro image plane\n        device_projection = go_pro_proxy[go_pro][\"camera\"].project(pose_in_go_pro_world)\n        if device_projection is None:\n            continue\n        else:\n            per_go_pro_reprojection[go_pro][part] = {'x': device_projection[0], 'y': device_projection[1], 'placement': 'manual'}\n")),(0,o.kt)("p",null,"We define the keypoints_map, skeleton and pose_kpt_color for visualization."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'if annotation_type == "body":\n    keypoints_map, skeleton, pose_kpt_color = get_body_metadata()\nelse:\n    keypoints_map, skeleton, pose_kpt_color = get_hands_metadata()\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"projection_results = {}\nfor cam_name in per_go_pro_reprojection.keys():\n    viz_img = get_viz(\n        videos[cam_name],\n        keypoints_map,\n        per_go_pro_reprojection[cam_name],\n        skeleton,\n        pose_kpt_color,\n        annot_type=annotation_type,\n    )\n    projection_results[cam_name] = viz_img\nshow_results(projection_results)\n")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"png",src:t(7683).Z,width:"2757",height:"1590"})),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"png",src:t(9152).Z,width:"2757",height:"1590"})),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"png",src:t(4810).Z,width:"2757",height:"1590"})),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"png",src:t(5441).Z,width:"2757",height:"1590"})),(0,o.kt)("h3",{id:"3-projecting-pose-to-egocentric-view-using-camera-info"},"3. Projecting pose to egocentric view using camera info"),(0,o.kt)("p",null,"In this section, we further provide instructions projecting hand pose to egocentric view, since hand-object interaction is an important part of egocentric video analysis. The projection includes the following steps:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"retrieve 3D pose of the hand keypoint as world coordinates from annotation"),(0,o.kt)("li",{parentName:"ol"},"retrieve camera intrinsics and extrinsics from camera_info"),(0,o.kt)("li",{parentName:"ol"},"project the 3D keypoint from world to aria device with camera extrinsics"),(0,o.kt)("li",{parentName:"ol"},"project the 3D keypoint from aria device to aria image plane with camera intrinsics"),(0,o.kt)("li",{parentName:"ol"},"get the resulted 2D keypoint")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'takes_info = json.load(open(os.path.join(release_dir, "takes.json")))\n\n# go through all takes to locate the sampled take, i.e., cmu_bike01_5\ntake_name = take["take_name"]\nimport re\n\n# get the capture name, and load the timesync.csv\ncapture_name = re.sub(r"_\\d+$", "", take_name)\ntimesync = pd.read_csv(os.path.join(release_dir, f"captures/{capture_name}/timesync.csv"))\n\nstart_idx = take["timesync_start_idx"]+1\nend_idx = take["timesync_end_idx"]\ntake_timestamps = []\nfor idx in range(start_idx, end_idx):\n    take_timestamps.append(int(timesync.iloc[idx][f"aria01_214-1_capture_timestamp_ns"]))\nsample_timestamp = take_timestamps[int(frame_idx)]\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"ego_reprojection = {}\npose_info = mps_data_provider.get_closed_loop_pose(sample_timestamp)\n\ncam = ego_cam_name\nfor part in parts:\n    pose_vector_in_world = annot_3d[part]\n\n    if pose_info:\n        # transform coordinates from device to world\n        T_world_device = pose_info.transform_world_device\n\n    T_device_camera = rgb_camera_calibration.get_transform_device_camera()\n    T_world_camera = T_world_device @ T_device_camera\n\n    pose_in_aria_world = T_world_camera.inverse() @ pose_vector_in_world\n    device_projection = rgb_camera_calibration.project(pose_in_aria_world)\n\n    if device_projection is None:\n        continue\n    else:\n        x_coord = device_projection[0]\n        y_coord = device_projection[1]\n        ego_reprojection[part] = {'x': x_coord, 'y': y_coord, 'placement': 'auto'}\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Loaded #closed loop trajectory poses records: 646865\n")),(0,o.kt)("p",null,"Now let's visualize the projected hand pose on the aria frame."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"ego_local_path = os.path.join(base_directory, take['frame_aligned_videos'][ego_cam_name]['rgb']['relative_path'])\nego_frame = get_frame(ego_local_path, frame_idx)\nif annotation_type == 'hand':\n    cam_name = ego_cam_name\n    ann = ego_reprojection\n    img = ego_frame\n    img = img.rotate(90)\n    image_array = np.asarray(img)\n    image = Image.fromarray(image_array, \"RGB\")\n\n    viz_img = get_viz(image, keypoints_map, ann, skeleton, pose_kpt_color, annot_type=annotation_type, is_aria=True)\n    plt.figure(figsize=(8, 8))\n    plt.imshow(viz_img.rotate(270))\n    plt.axis(\"off\")  # Hide the axes ticks\n    plt.title(f\"{cam_name}\")\n    plt.show()\n")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"png",src:t(5640).Z,width:"636",height:"658"})),(0,o.kt)("h3",{id:"conclusion"},"Conclusion"),(0,o.kt)("p",null,"In this notebook, we reviewed loading takes, its egocentric and exocentric camera calibrations and EgoPose annotations. We also provided a step-by-step guide on projecting 3D hand/body keypoints to different views with the camera calibrations. This can serve as a good starting point to understand EgoPose and utilize it for research in the future."),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/facebookresearch/Ego4d"},(0,o.kt)("img",{parentName:"a",src:"https://img.shields.io/static/v1.svg?logo=star&label=%E2%AD%90&message=Star%20Our%20Repository&color=yellow",alt:"Star our repository"})),"  If you found this tutorial helpful, consider \u2b50-ing our repository."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/facebookresearch/Ego4d/issues"},(0,o.kt)("img",{parentName:"a",src:"https://img.shields.io/static/v1.svg?logo=star&label=%E2%9D%94&message=Ask%20Questions&color=9cf",alt:"Ask questions"})),"  For any questions, typos, or bugs that you found, please raise an issue on GitHub."),(0,o.kt)("hr",null))}_.isMDXComponent=!0},2923:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/hand_body_pose-1040ecb7222b8a5865e444aa4e5c9c36.png"},7683:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/pose_tutorial-0-018f5305b6365157a797ad2666191c65.png"},9152:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/pose_tutorial-1-23f48afa2431fdddb60f1bdb0741f7d4.png"},4810:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/pose_tutorial-2-efa4f4af15232cf9b5e963290d59b612.png"},5441:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/pose_tutorial-3-103cd05fabff53353a72bc3a58047fd5.png"},5640:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/pose_tutorial-4-ddd89629042507c68d8f282cf3d49978.png"}}]);